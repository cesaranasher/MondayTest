{"ast":null,"code":"var __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (g && (g = 0, op[0] && (_ = 0)), _) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nimport { BadRequestError, InternalServerError } from '../errors/apps-sdk-error.js';\nimport { getGcpConnectionData, getGcpIdentityToken } from '../gcp/gcp.js';\nimport { isDefined } from '../types/guards.js';\nimport { getMondayCodeContext, validateEnvironment } from '../utils/env.js';\nimport { fetchWrapper } from '../utils/fetch-wrapper.js';\nimport { Logger } from '../utils/logger.js';\nimport { TIME_IN_MILLISECOND } from '../utils/time-enum.js';\nimport { isObject } from '../utils/validations.js';\nvar logger = new Logger('SecureStorage', {\n  mondayInternal: true\n});\nvar MIN_TOKEN_EXPIRE_TTL_HOURS = 0.5;\n\nvar secureStorageFetch = function (path, connectionData, options) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var _a, method, body, token, identityToken, fetchObj, result, error_1;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          _a = options.method, method = _a === void 0 ? 'GET' : _a, body = options.body;\n\n          if (!isDefined(path)) {\n            throw new BadRequestError('`path` must be provided');\n          }\n\n          token = connectionData.token, identityToken = connectionData.identityToken;\n          fetchObj = {\n            headers: __assign(__assign({\n              'Content-Type': 'application/json'\n            }, token && {\n              'X-Vault-Token': token\n            }), identityToken && {\n              'Authorization': \"Bearer \".concat(identityToken)\n            }),\n            method: method,\n            body: body ? JSON.stringify(body) : undefined\n          };\n          _b.label = 1;\n\n        case 1:\n          _b.trys.push([1, 3,, 4]);\n\n          return [4\n          /*yield*/\n          , fetchWrapper(path, fetchObj)];\n\n        case 2:\n          result = _b.sent();\n          return [3\n          /*break*/\n          , 4];\n\n        case 3:\n          error_1 = _b.sent();\n          logger.debug('[secureStorageFetch] Unexpected error occurred while communicating with secure storage', {\n            error: error_1\n          });\n          throw new InternalServerError('An issue occurred while accessing secure storage');\n\n        case 4:\n          if (!isDefined(result)) {\n            return [2\n            /*return*/\n            ];\n          }\n\n          if (isDefined(result.errors)) {\n            logger.debug(\"[secureStorageFetch] Errors occurred while communicating with secure storage.\\nErrors: \".concat(result.errors.join()));\n            throw new BadRequestError('Provided input is invalid');\n          }\n\n          if (!isDefined(result.data)) {\n            throw new InternalServerError('some thing went wrong when when communicating with secure storage');\n          }\n\n          return [2\n          /*return*/\n          , result.data];\n      }\n    });\n  });\n};\n\nvar generateCrudPath = function (path, id) {\n  var secureStorageAddress = getMondayCodeContext().secureStorageAddress;\n\n  if (!isDefined(path)) {\n    throw new BadRequestError('Missing secret key');\n  }\n\n  if (!isDefined(id)) {\n    logger.debug('[generateCrudPath] projectId is not defined');\n    throw new InternalServerError('An issue occurred while accessing secure storage');\n  }\n\n  var generalSecretPath = 'v1/kv/data';\n  var fullPath = \"\".concat(secureStorageAddress, \"/\").concat(generalSecretPath, \"/\").concat(id, \"/\").concat(path);\n  return fullPath;\n};\n\nvar getToken = function (gcpCredentials, connectionData) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var secureStorageAddress, loginUrl, body, loginResponse, token;\n\n    var _a;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          secureStorageAddress = getMondayCodeContext().secureStorageAddress;\n          loginUrl = \"\".concat(secureStorageAddress, \"/v1/auth/gcp/login\");\n          body = JSON.stringify({\n            role: gcpCredentials.projectId,\n            jwt: gcpCredentials.token\n          });\n          return [4\n          /*yield*/\n          , fetchWrapper(loginUrl, {\n            method: 'POST',\n            body: body,\n            headers: {\n              Authorization: \"Bearer \".concat(connectionData.identityToken)\n            }\n          })];\n\n        case 1:\n          loginResponse = _b.sent();\n\n          if (!isDefined(loginResponse)) {\n            logger.warn('[getToken] invalid gcp login response');\n            throw new InternalServerError('An error occurred while authenticating');\n          }\n\n          token = (_a = loginResponse === null || loginResponse === void 0 ? void 0 : loginResponse.auth) === null || _a === void 0 ? void 0 : _a.client_token;\n          return [2\n          /*return*/\n          , token];\n      }\n    });\n  });\n};\n\nvar getTokenExpiry = function (connectionData) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var secureStorageAddress, lookupUrl, response;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          secureStorageAddress = getMondayCodeContext().secureStorageAddress;\n          lookupUrl = \"\".concat(secureStorageAddress, \"/v1/auth/token/lookup-self\");\n          return [4\n          /*yield*/\n          , secureStorageFetch(lookupUrl, connectionData, {\n            method: 'GET'\n          })];\n\n        case 1:\n          response = _a.sent();\n\n          if (!isDefined(response)) {\n            throw new InternalServerError('An error occurred while authenticating');\n          }\n\n          return [2\n          /*return*/\n          , response.expire_time];\n      }\n    });\n  });\n};\n\nvar getConnectionData = function (connectionData) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var gcpCredentials, _a, expireTime, token, identityToken;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , getGcpConnectionData()];\n\n        case 1:\n          gcpCredentials = _b.sent();\n          _a = connectionData;\n          return [4\n          /*yield*/\n          , getToken(gcpCredentials, connectionData)];\n\n        case 2:\n          _a.token = _b.sent();\n          return [4\n          /*yield*/\n          , getTokenExpiry(connectionData)];\n\n        case 3:\n          expireTime = _b.sent();\n          token = connectionData.token, identityToken = connectionData.identityToken;\n          return [2\n          /*return*/\n          , {\n            token: token,\n            expireTime: expireTime,\n            id: gcpCredentials.projectId,\n            identityToken: identityToken\n          }];\n      }\n    });\n  });\n};\n\nvar authenticate = function (connectionData) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var _a, expireTime, token, id, identityToken, tokenTtlInHours, ttlPassedThreshold;\n\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          validateEnvironment();\n\n          if (!isDefined(connectionData)) {\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore\n            connectionData = {};\n          }\n\n          _a = connectionData;\n          return [4\n          /*yield*/\n          , getGcpIdentityToken(connectionData === null || connectionData === void 0 ? void 0 : connectionData.identityToken)];\n\n        case 1:\n          _a.identityToken = _b.sent();\n          if (!!isDefined(connectionData.token)) return [3\n          /*break*/\n          , 3];\n          return [4\n          /*yield*/\n          , getConnectionData(connectionData)];\n\n        case 2:\n          return [2\n          /*return*/\n          , _b.sent()];\n\n        case 3:\n          expireTime = connectionData.expireTime, token = connectionData.token, id = connectionData.id, identityToken = connectionData.identityToken;\n          tokenTtlInHours = (new Date(expireTime).getTime() - new Date().getTime()) / TIME_IN_MILLISECOND.HOUR;\n          ttlPassedThreshold = tokenTtlInHours <= MIN_TOKEN_EXPIRE_TTL_HOURS;\n          if (!ttlPassedThreshold) return [3\n          /*break*/\n          , 5];\n          return [4\n          /*yield*/\n          , getConnectionData(connectionData)];\n\n        case 4:\n          return [2\n          /*return*/\n          , _b.sent()];\n\n        case 5:\n          if (!isDefined(id)) {\n            logger.debug('[authenticate] projectId is not defined');\n            throw new InternalServerError('An issue occurred while accessing secure storage');\n          }\n\n          return [2\n          /*return*/\n          , {\n            token: token,\n            expireTime: expireTime,\n            id: id,\n            identityToken: identityToken\n          }];\n      }\n    });\n  });\n};\n\nvar SecureStorage =\n/** @class */\nfunction () {\n  function SecureStorage() {\n    validateEnvironment();\n  }\n\n  SecureStorage.prototype[\"delete\"] = function (key) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, fullPath;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            _a = this;\n            return [4\n            /*yield*/\n            , authenticate(this.connectionData)];\n\n          case 1:\n            _a.connectionData = _b.sent();\n            fullPath = generateCrudPath(key, this.connectionData.id);\n            return [4\n            /*yield*/\n            , secureStorageFetch(fullPath, this.connectionData, {\n              method: 'DELETE'\n            })];\n\n          case 2:\n            _b.sent();\n\n            logger.info(\"[SecureStorage] Deleted data for key from secure storage\\nkey: \".concat(key), {\n              mondayInternal: false\n            });\n            return [2\n            /*return*/\n            , true];\n        }\n      });\n    });\n  };\n\n  SecureStorage.prototype.get = function (key) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, fullPath, result;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            _a = this;\n            return [4\n            /*yield*/\n            , authenticate(this.connectionData)];\n\n          case 1:\n            _a.connectionData = _b.sent();\n            fullPath = generateCrudPath(key, this.connectionData.id);\n            return [4\n            /*yield*/\n            , secureStorageFetch(fullPath, this.connectionData, {\n              method: 'GET'\n            })];\n\n          case 2:\n            result = _b.sent();\n            logger.info(\"[SecureStorage] Got data for key from secure storage\\nkey: \".concat(key), {\n              mondayInternal: false\n            });\n\n            if (!isDefined(result === null || result === void 0 ? void 0 : result.data)) {\n              return [2\n              /*return*/\n              , null];\n            }\n\n            return [2\n            /*return*/\n            , result === null || result === void 0 ? void 0 : result.data];\n        }\n      });\n    });\n  };\n\n  SecureStorage.prototype.set = function (key, value) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, fullPath, formalizedValue;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            _a = this;\n            return [4\n            /*yield*/\n            , authenticate(this.connectionData)];\n\n          case 1:\n            _a.connectionData = _b.sent();\n            fullPath = generateCrudPath(key, this.connectionData.id);\n            formalizedValue = isObject(value) ? value : {\n              value: value\n            };\n            return [4\n            /*yield*/\n            , secureStorageFetch(fullPath, this.connectionData, {\n              method: 'PUT',\n              body: {\n                data: formalizedValue\n              }\n            })];\n\n          case 2:\n            _b.sent();\n\n            logger.info(\"[SecureStorage] Set data for key in secure storage\\nkey: \".concat(key), {\n              mondayInternal: false\n            });\n            return [2\n            /*return*/\n            , true];\n        }\n      });\n    });\n  };\n\n  return SecureStorage;\n}();\n\nexport { SecureStorage };","map":{"version":3,"mappings":"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","names":["BadRequestError","InternalServerError","getGcpConnectionData","getGcpIdentityToken","isDefined","getMondayCodeContext","validateEnvironment","fetchWrapper","Logger","TIME_IN_MILLISECOND","isObject","logger","mondayInternal","MIN_TOKEN_EXPIRE_TTL_HOURS","secureStorageFetch","path","connectionData","options","_a","body","token","identityToken","fetchObj","headers","method","JSON","stringify","undefined","result","_b","debug","error","error_1","errors","join","data","generateCrudPath","id","secureStorageAddress","generalSecretPath","fullPath","concat","getToken","gcpCredentials","loginUrl","role","projectId","jwt","Authorization","loginResponse","warn","auth","client_token","getTokenExpiry","lookupUrl","response","expire_time","getConnectionData","expireTime","authenticate","tokenTtlInHours","Date","getTime","HOUR","ttlPassedThreshold","SecureStorage","key","info","value","formalizedValue"],"sourceRoot":"","sources":["../../../lib/secure-storage/secure-storage.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}